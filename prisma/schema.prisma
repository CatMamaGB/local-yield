// The Local Yield - Phase 1: Marketplace for Local Goods
// https://pris.ly/d/prisma-schema
//
// Listing types (one domain, two experiences):
//   Market = Product (this table). Care = ServiceListing (separate table, later).
//   Do not unify into one "Listing" table; keep two tables. Shared across both:
//   - Users (this User model; Care will add roles/fields as needed)
//   - Reviews / issue resolution (Review model can later reference ServiceListing orders)
//   - Location (User.zipCode, etc.; Care will use same)
//   - Messaging (future: shared Conversation/Message model)
// When adding Care: add ServiceListing (and CareOrder/CareBooking) tables; reuse User, Review, location concepts.

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum Role {
  BUYER
  PRODUCER
  ADMIN
}

model User {
  id        String    @id @default(cuid())
  email     String    @unique
  name      String?
  role      Role      @default(BUYER)
  zipCode   String
  bio       String?
  avatarUrl String?
  createdAt DateTime  @default(now())

  products     Product[]
  ordersAsBuyer    Order[]    @relation("OrderBuyer")
  ordersAsProducer Order[]    @relation("OrderProducer")
  events       Event[]
  reviewsReceived Review[]   @relation("ReviewProducer")
  reviewsGiven   Review[]   @relation("ReviewReviewer")
  subscriptionsAsSubscriber Subscription[] @relation("SubscriptionSubscriber")
  subscriptionsAsProducer   Subscription[] @relation("SubscriptionProducer")
  itemRequests ItemRequest[]
}

model Product {
  id          String   @id @default(cuid())
  title       String
  description String
  price       Float
  stockImage  String?
  imageUrl    String?
  category    String
  delivery    Boolean
  pickup      Boolean
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt   DateTime @default(now())

  orders       Order[]
  eventProducts EventProduct[]
}

model Order {
  id         String   @id @default(cuid())
  buyerId    String
  producerId String
  productId  String
  notes      String?
  paid       Boolean  @default(false)
  viaCash    Boolean  @default(false)
  pickupDate DateTime
  createdAt  DateTime @default(now())
  /// After this time, buyer may publish a negative public review (resolution window).
  resolutionWindowEndsAt DateTime?
  /// Pickup code / QR for event or pickup (show at confirmation).
  pickupCode String?

  buyer    User    @relation("OrderBuyer", fields: [buyerId], references: [id], onDelete: Cascade)
  producer User    @relation("OrderProducer", fields: [producerId], references: [id], onDelete: Cascade)
  product  Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  reviews  Review[]
}

// Subscription references producer by userId (producer); add producerId to User if needed later

/// Events: "Pick up at market booth Saturday". Preorder + pickup QR (add on Order/EventOrder when building checkout).
model Event {
  id            String   @id @default(cuid())
  userId        String
  name          String
  location      String
  eventDate     DateTime
  allowPreorder Boolean  @default(true)
  createdAt     DateTime @default(now())

  user     User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  products EventProduct[]
}

model EventProduct {
  eventId   String
  productId String
  event     Event   @relation(fields: [eventId], references: [id], onDelete: Cascade)
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@id([eventId, productId])
}

model Review {
  id          String   @id @default(cuid())
  reviewerId  String
  producerId  String
  orderId     String
  privateFlag Boolean  @default(true)
  comment     String
  resolved    Boolean  @default(false)
  createdAt   DateTime @default(now())
  /// Structured rating 1â€“5 for public display (short + structured, no rant walls).
  rating           Int?
  /// Producer response: fix/refund/replace (visible alongside review).
  producerResponse String?
  /// Admin moderation: hide abusive or off-topic content.
  hiddenByAdmin    Boolean   @default(false)

  reviewer User  @relation("ReviewReviewer", fields: [reviewerId], references: [id], onDelete: Cascade)
  producer User  @relation("ReviewProducer", fields: [producerId], references: [id], onDelete: Cascade)
  order    Order @relation(fields: [orderId], references: [id], onDelete: Cascade)
}

model Subscription {
  id          String   @id @default(cuid())
  userId      String
  producerId  String
  weeklyBox   Boolean  @default(true)
  active      Boolean  @default(true)
  createdAt   DateTime @default(now())

  subscriber User @relation("SubscriptionSubscriber", fields: [userId], references: [id], onDelete: Cascade)
  producer   User @relation("SubscriptionProducer", fields: [producerId], references: [id], onDelete: Cascade)
}

/// Request an item: buyers ask for eggs, honey, etc.; producers see demand in their radius (liquidity).
model ItemRequest {
  id          String   @id @default(cuid())
  requesterId String
  description String
  zipCode     String
  radiusMiles Int?     /// Optional; producers within radius see it.
  status      String   @default("open") /// open | fulfilled | closed
  createdAt   DateTime @default(now())

  requester User @relation(fields: [requesterId], references: [id], onDelete: Cascade)
}
